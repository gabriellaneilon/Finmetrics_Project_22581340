---
# IMPORTANT: Change settings here, but DO NOT change the spacing.
# Remove comments and add values where applicable.
# The descriptions below should be self-explanatory

title: "Optimizing Portfolio Strategies: A Comparative Study of Mean-Variance, Minimum-Variance, Equally Weighted, and Risk Parity Portfolios"
#subtitle: "This will appear as Right Header"

documentclass: "elsarticle"

# --------- Thesis title (Optional - set to FALSE by default).
# You can move the details below around as you please.
Thesis_FP: FALSE
# Entry1: "An unbelievable study with a title spanning multiple lines."
# Entry2: "\\textbf{Some Guy}" # textbf for bold
# Entry3: "A thesis submitted toward the degree of Doctor of Philosophy"
# Uni_Logo: Tex/Logo.png # Place a logo in the indicated location (from your root, e.g. defaults to ~/Tex/Logo.png) and uncomment this line. Leave uncommented for no image
# Logo_width: 0.3 # If using a logo - use this to set width (size) of image
# Entry4: "Under the supervision of: \\vfill Prof. Joe Smith and Dr. Frank Smith"
# Entry5: "Stellenbosch University"
# Entry6: April 2020
# Entry7:
# Entry8:

# --------- Front Page
# Comment: ----- Follow this pattern for up to 5 authors
AddTitle: TRUE # Use FALSE when submitting to peer reviewed platform. This will remove author names.
Author1: "Gabriella Neilon"  # First Author - note the thanks message displayed as an italic footnote of first page.
Ref1: "Stellenbosch University" # First Author's Affiliation
Email1: "22581340\\@sun.ac.za" # First Author's Email address

# Author2: "John Smith"
# Ref2: "Some other Institution, Cape Town, South Africa"
# Email2: "John\\@gmail.com"
# CommonAffiliation_12: TRUE # If Author 1 and 2 have a common affiliation. Works with _13, _23, etc.
# 
# Author3: "John Doe"
# Email3: "Joe\\@gmail.com"

CorrespAuthor_1: TRUE  # If corresponding author is author 3, e.g., use CorrespAuthor_3: TRUE

# Comment out below to remove both. JEL Codes only given if keywords also given.
# keywords: "Multivariate GARCH \\sep Kalman Filter \\sep Copula" # Use \\sep to separate
# JELCodes: "L250 \\sep L100"

# ----- Manage headers and footers:
#BottomLFooter: $Title$
#BottomCFooter:
#TopLHeader: \leftmark # Adds section name at topleft. Remove comment to add it.
BottomRFooter: "\\footnotesize Page \\thepage" # Add a '#' before this line to remove footer.
addtoprule: TRUE
addfootrule: TRUE               # Use if footers added. Add '#' to remove line.

# --------- page margins:
margin: 2.3 # Sides
bottom: 2 # bottom
top: 2.5 # Top
HardSet_layout: TRUE # Hard-set the spacing of words in your document. This will stop LaTeX squashing text to fit on pages, e.g.
# This is done by hard-setting the spacing dimensions. Set to FALSE if you want LaTeX to optimize this for your paper.

# --------- Line numbers
linenumbers: FALSE # Used when submitting to journal

# ---------- References settings:
# You can download cls format here: https://www.zotero.org/ - simply search for your institution. You can also edit and save cls formats here: https://editor.citationstyles.org/about/
# Hit download, store it in Tex/ folder, and change reference below - easy.
bibliography: Tex/ref.bib      # Do not edit: Keep this naming convention and location.
csl: Tex/harvard-stellenbosch-university.csl # referencing format used.
# By default, the bibliography only displays the cited references. If you want to change this, you can comment out one of the following:
#nocite: '@*' # Add all items in bibliography, whether cited or not
# nocite: |  # add specific references that aren't cited
#  @grinold2000
#  @Someoneelse2010

# ---------- General:
RemovePreprintSubmittedTo: TRUE  # Removes the 'preprint submitted to...' at bottom of titlepage
#Journal: "Journal of Finance"   # Journal that the paper will be submitting to, if RemovePreprintSubmittedTo is set to TRUE.
toc: TRUE                      # Add a table of contents
numbersections: TRUE             # Should sections (and thus figures and tables) be numbered?
fontsize: 12pt                  # Set fontsize
linestretch: 1.2                # Set distance between lines.
link-citations: TRUE            # This creates dynamic links to the papers in reference list.

### Adding additional latex packages:
header-includes:
   - \usepackage{amsmath} # Add additional packages here.

output:
  pdf_document:
    keep_tex: TRUE
    template: Tex/TexDefault.txt
    fig_width: 6 # Adjust default figure sizes. This can also be done in the chunks of the text.
    fig_height: 6
abstract: |
    This paper critically examines the effectiveness of Mean-Variance Optimization (MVO), Minimum-Variance Portfolio (MVP), Equally Weighted and Risk Parity portfolio strategies in the the long run and during volatile periods. While MVO aims to maximize expected returns while minimizing risks, it often results in concentrated portfolios vulnerable to abrupt changes. MVP, focusing on minimizing overall portfolio variance without explicit return predictions, faces issues of concentration on low-volatility assets. The study introduces Risk Parity portfolios as an alternative strategy, emphasizing risk budgeting to achieve optimal risk diversification. The study concludes that all three portfolio strategies consistently outperform the S&P 500 index, demonstrating their potential for delivering superior risk-adjusted returns across various market conditions. Notably, Risk Parity portfolios exhibit balanced risk contributions, making them resilient in downturns, and the MVP strategy stands out with promising risk-adjusted returns. The research provides valuable insights for investors seeking optimal portfolio strategies in dynamic markets.
---

<!-- First: Set your default preferences for chunk options: -->

<!-- If you want a chunk's code to be printed, set echo = TRUE. message = FALSE stops R printing ugly package loading details in your final paper too. I also suggest setting warning = FALSE and checking for warnings in R, else you might find ugly warnings in your paper. -->
\newpage

```{r, include=FALSE}


knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')
# Note: Include = FALSE implies the code is executed, but not printed in your pdf.
# warning and message = FALSE implies ugly messages and warnings are removed from your pdf.
# These should be picked up when you execute the command chunks (code sections below) in your rmd, not printed in your paper!

library(tidyverse)
library(zoo)
library("RcppRoll")
library(fmxdat)
if (!require("rmsfuns")) install.packages("rmsfuns")
library(rmsfuns)
library(tidyverse)
pacman::p_load(tbl2xts)
library(truncdist)
library(rportfolios)
library(rmsfuns)
pacman::p_load("tidyr", "tbl2xts","devtools","lubridate", "readr", "PerformanceAnalytics", "ggplot2", "dplyr")
pacman::p_load("tidyverse", "devtools", "FactoMineR", "factoextra", "broom", "rmsfuns")
library(rmsfuns)
load_pkg("PerformanceAnalytics")
pacman::p_load("tbl2xts")
pacman::p_load("xts", "tidyverse", "tbl2xts", "PerformanceAnalytics", 
    "lubridate", "glue")

library(ggExtra)
library(MTS)
library(gt)

library(Texevier)
library(tinytex)
library("riskParityPortfolio")

```

```{r}
#Loading data


global <- read_rds("/Users/gabriellaneilon/Library/Mobile Documents/com~apple~CloudDocs/Masters/2nd Semester/Financial Econometrics/Financial Econometrics Project/Data/Global_Indices.rds")
Indexes <- read_rds("/Users/gabriellaneilon/Library/Mobile Documents/com~apple~CloudDocs/Masters/Data_23/Cncy_Hedge_Assets.rds") 


# combine glibal indexes with loc al SA indexes 
d1 <- global %>%
  select(Name, Returns, date, YM) %>%
  spread(key = Name, value = Returns)

testing <- ceiling_date(Indexes$date, "month") - days(1)

Indexes$date <- testing



dates <- dateconverter(as.Date("2002-02-28"),as.Date("2023-08-31"),
    "calendarEOM")




RSA_indexes <- Indexes %>% select(date,J433, ALBI)

indexes_final <- RSA_indexes%>% filter(date %in% dates)

combined_data <- left_join(d1, RSA_indexes, by="date")

final_data <- combined_data %>% select(-"AfricaXSA",-"FTSE EPRA/NAREIT Developed Dividend+ Index",-"FTSE Global Core Infrastructure Net Return", -"MSCI World Emerging Market", -"US 3 Month Libor Rate", -"US Inflation Linkers", -"VIX",-"BRENT",-"SP 500") %>% gather(Name, Returns, -date,-YM) 

plotdf <- 
final_data %>% 
# %>% group_by(Name) %>% 
# # Epic sorcery:
# mutate(RollRets = RcppRoll::roll_prod(1 + Returns, 36, fill = NA, 
#     align = "right")^(12/36) - 1) %>% 
# # Note this cool trick: it removes dates that have no
# # RollRets at all.
# 
# group_by(date) %>% filter(any(!is.na(RollRets))) %>% 
# ungroup()
filter(Name %in%  c("Gold Spot $/Oz (GOLDS COMDTY)","GlobalAgg Unhedged USD", "MSCI ACWI", "J433", "ALBI"))
```


<!-- ############################## -->
<!-- # Start Writing here: -->
<!-- ############################## -->

\newpage
# Introduction {-}

The inception of Modern Portfolio Theory (MPT) by Markowitz in 1952 revolutionized portfolio optimization, emphasizing the dual goals of maximizing returns while minimizing risks. However, the application of MPT strategies such as Mean-Variance Optimization (MVO) and Minimum-Variance Portfolio (MVP) has faced criticism due to concentration issues and challenges in risk diversification. To address these concerns, Risk Parity Portfolios emerged as an alternative approach, aiming to balance risk contributions across assets. This paper investigates and compares these strategies, aiming to provide a comprehensive understanding of their efficacy and limitations in modern financial landscapes.

# Literature Review \label{-}

## Mean-Variance Optimization (MVO)
The concept of _Modern Portfolio Theory_ traces its origins to the pioneering work by Markowitz in 1952. This theory emphasizes the dual objectives of maximizing expected returns while minimizing risks, standing as the cornerstone in portfolio optimization [@markowits1952portfolio]. The approach employs the fundamental principles of portfolio diversification and leverages covariance relationships. Portfolio diversification, integral to risk reduction, is crucial as portfolio investment risk (variance) is impacted by both individual asset variances and covariances in a bipartite manner. However, the risk mitigation aspect of portfolio diversification should be approached judiciously, as its primary potential lies in mitigating unsystematic risk rather than systematic risk.

The primary aim of mean-variance optimization is to minimize portfolio volatility while targeting an expected return. However, mean-variance optimization often leads to highly concentrated portfolios, making them vulnerable to abrupt changes in allocations due to minor input variations. There exists confusion between optimizing volatility and risk diversification [@bruder2012managing].

Despite its foundational principles, mean–variance optimization (MVO) faces scrutiny when confronted with contemporary challenges, particularly financial crises. Critics argue that it overlooks risk diversification and only takes the portfolio's overall risk into account, which results in an excessive concentration of risk in a small number of assets—as was shown during the 2008 financial crisis. This critique, additionally, questions the reliance of Modern Portfolio Theory (MPT) on historical data as is also it is highly sensitive to parameter estimation errors , suggesting its potential irrelevance in current and future markets. Consequently, MPT's predictive capacity becomes less dependable and more susceptible to deviations from actual market behavior [@steinbach2001markowitz]. Another area of criticism pertains to Markowitz's definition of risk, often equated with "volatility" (both upside and downside). This overlooks the perspective that investors aren't inherently risk-averse; rather, they exhibit a tendency toward aversion to losses, therefore in actuality, the variance is a poor indicator of risk because it penalizes both desired low losses and unwanted large losses. As Harold Evensky, a renowned financial planner and the founder of Evensky & Katz Foldes Wealth Management, states, *"Investors aren't risk-averse, they're loss-averse."* 


## Minimum-Variance Portfolio (MVP)

The Minimum-Variance Portfolio (MVP) seeks to create a portfolio with the lowest possible risk among a set of assets without emphasizing explicit return predictions, contrasting with the Mean-Variance Optimization (MVO) method.

In the MVP, the primary aim is to allocate weights to assets to minimize overall portfolio variance. However, this approach tends to concentrate on low-volatility assets, resulting in less diversified portfolios with uneven weight distributions [@lohre2014diversifying]. 

This portfolio is at the left-most end of the mean-variance efficient frontier possessing the unique trait of having security weights independent of expected returns on individual securities. Although all portfolios on the efficient frontier aim to minimize risk for a given return, the minimum-variance portfolio achieves this without considering expected returns directly [@clarke2013risk].

Despite its potential benefits, minimum-variance portfolios commonly struggle with concentration issues [@maillard2010properties]. Ans across different portfolio components.


## Risk Parity Portfolios

The criticism of MVO and MVP introduces alternative portfolio optimization strategies, with a particular focus on risk budgeting (or diversified risk parity strategies). This strategy is widely accepted in both academic and professional circles [@meucci2005risk; @meucci2009managing; @choueifaty2008toward; @bruder2012managing; @lohre2012diversified; @maillard2010properties]. 

The resolution to concentrated risk in a select few assets observed in both Mean-Variance Optimization (MVO) and Minimum Variance Portfolio (MVP) strategies appears to lie in the adoption of a Risk Parity portfolio.  @maillard2010properties delves into the theoretical properties of the risk budgeting portfolio, demonstrating its volatility positioning between the minimum variance and weight budgeting portfolios  Unlike the minimum variance portfolio, the Risk Parity portfolio is invested in all assets. While its volatility is greater than the minimum variance portfolio but smaller than the 1/N strategy, the Risk Parity portfolio maintains more balanced risk contributions, even though it ranks similarly to a MVP in terms of weight distribution. 

In contrast to minimum-variance portfolios that equalize the marginal contributions of each asset to portfolio risk, risk parity portfolios equalize the total risk contribution, minimum-variance portfolios, positioning risk parity portfolios slightly inside the efficient frontier rather than on it [@clarke2013risk, p. 40].

And unlike Mean-Variance Optimization (MVO), risk parity portfolios do not explicitly prioritize the expected return or the risk of a portfolio. Nonetheless, they do necessitate a positive expected return [@fisher2015risk, p. 42]. Furthermore, the purpose of risk parity is not solely to minimize portfolio risk like standard MVO portfolios. Instead, by equalizing asset risk contributions, risk parity aims for optimal risk diversification [@costa2020robust].

Initially, a risk parity portfolio defined weights based on asset class inverse volatility, disregarding their correlations [@clarke2013risk, p. 39]. Subsequently, @qian2005financial developed a more comprehensive definition that considers correlations and grounds the property in a risk budget where weights are adjusted to ensure each asset contributes equally to portfolio risk.

They allocate weights to different asset classes based on their risk measures, ensuring each asset contributes an equal risk amount to the portfolio and reducing estimation noise [@maillard2010properties]. This approach emphasizes risk allocation, typically defined as volatility, rather than capital allocation. By adjusting asset allocations to the same risk level, the risk parity portfolio can achieve a higher Sharpe ratio and better withstand market downturns compared to traditional portfolios. It ensures a well-diversified portfolio by requiring each asset to contribute the same level of risk [@merton1980estimating].

Furthermore, @ardia2017impact demonstrate that risk parity portfolios are less susceptible to covariance misspecification compared to other risk-based investment strategies.

Nevertheless, the Risk Parity portfolio is not devoid of shortcomings.
@maillard2010properties [p. 16] points out that even though minimum variance portfolios face constraints due to asset concentration, risk parity portfolios lack adequate risk oversight. However, implementing this approach optimizes risk distribution, acting as a balanced risk filter that prevents any single asset from dominating the portfolio, as observed in the case of the MVP.


<!-- The following is a code chunk. It must have its own unique name (after the r), or no name. After the comma follows commands for R which are self-explanatory. By default, the code and messages will not be printed in your pdf, just the output: -->



<!-- :::::: {.columns data-latex="[T]"} -->
<!-- ::: {.column data-latex="{0.7\textwidth}"} -->
<!-- ```{r, echo=FALSE, fig.width=4, fig.height=4} -->
<!-- par(mar = c(4, 4, .2, .1)) -->
<!-- plot(cars, pch = 19) -->
<!-- ``` -->
<!-- ::: -->
<!-- ::: {.column data-latex="{0.05\textwidth}"} -->
<!-- \ -->
<!-- ::: -->
<!-- ::: {.column data-latex="{0.2\textwidth}"} -->
<!-- \scriptsize -->

#  Portfolio construction

This paper aligns closely with @maillard2010properties by constructing a *Global diversified portfolio* and utilizes monthly data from 2002-02-28 to 2023-08-31 provided by @katzke2023portfoliocourse, focusing on various indices including the Morgan Stanley Capital International All Country World Index ("MSCI ACWI"), the Gold Spot rate ("Gold Spot $/Oz"), the Bloomberg Global Aggregate Bond Index ("GlobalAgg Unhedged USD"), the Capped SWIX All Share Index ("J433"), and the FTSE/JSE All Bond Index ("ALBI"). The analysis aims to compare various portfolio optimization strategies. Utilizing a standard shrinkage technique, covariance matrices are estimated for all strategies [@chaves2011risk].

The study adopts several global assumptions: (1) full investment  ($\boldsymbol{\omega^1} 1=1$), (2) a long-only strategy($\boldsymbol{\omega} \ge 0$). All portfolios undergo quarterly rebalancing, with an upper limit of 25% and a lower bound of 1% applied to all asset classes. Furthermore, Bonds are capped at 25%, Equities at 60%, and Gold at 10% exposure.

The analysis commences with a \textnormal{na\"{i}ve} $\frac{1}{N}$ , assigning equal weights to asset classes. Subsequently, Minimum Variance Optimization (MVO) and Minimum Variance Portfolio (MVP) techniques are implemented. Equations representing the minimum variance portfolios are detailed, encompassing both MVP and MVO, as provided by [@katzke2023portfolio]:


\begin{align}
\frac{1}{2} \boldsymbol{\omega^T*Dmat*\omega}=\boldsymbol{dvec^T\omega} \\
s.t. \ \boldsymbol{Amat * \omega \ge bvec}\\
\end{align}


\begin{align}
 \boldsymbol{\omega_{mvp}}= arg \min \boldsymbol{\omega' \Sigma\omega} \\
  s.t. \sum_{n=1}^{N} \omega_i = 1 \ and\ \omega \ge 0
\end{align}

\begin{align}
 \boldsymbol{\omega_{mvp}}= arg \min \boldsymbol{\omega' \Sigma\omega} \\
  s.t. \sum_{n=1}^{N} \omega_i = 1 \ and\ \omega \ge 0
\end{align}

\begin{align}
 \boldsymbol{\omega_{mvo}}= arg\max\ \ \boldsymbol{\mu}^T\omega-\lambda\boldsymbol{\omega^T\Sigma\omega} \\
  s.t. \sum_{n=1}^{N} \omega_i = 1 \ and\ \omega \ge 0
\end{align}

To ensure robustness against outliers in the dataset, a covariance matrix shrinkage approach, advocated by [@ledoit2003improved, is applied. Shrinkage serves to minimize the impact of outliers, enhancing the stability of covariance estimates.

\begin{align}
\hat{\Sigma}^{Shrunk}=(1-\rho)\ *  \hat{\Sigma} \ + \rho \ * T\\
with \ T= \frac{1}{N}Tr \times I
\end{align}




<!-- \begin{bmatrix} -->
<!-- 1  &  1  &  0  &  0   & 0   &  0 &  0 &  -1 &   0   &  0  &   0  &   0   &  0  &   1  &   0  &   0  &   0  &   0\\ -->
<!-- 1  &  0  &  1  &  0   & 0  &  0 &   0 &   0 &  -1  &   0  &   0  &   0   &  0  &   0   &  1  &   0  &   0   &  0\\ -->
<!-- 1  &  0  &  0  &  1   & 0  &  0 &   0 &   0 &  0  &   -1  &   0  &   0   &  0  &   0   &  0  &   0  &   0   &  0\\ -->
<!-- 1  &  0  &  0  &  0   & 1  &  0 &   0 &   0 &  0  &   0  &   -1  &   0   &  0  &   0   &  0  &   -1  &   0   &  0\\ -->
<!-- 1  &  0  &  0  &  0   & 0  &  1 &   0 &   0 &  0  &   0  &   0  &   -1   &  0  &   0   &  0  &   0  &   -1   &  0\\ -->
<!-- 1  &  0  &  0  &  0   & 0  &  0 &   1 &   0 &  0  &   0  &   0  &   0   &  -1  &   0   &  0  &   0  &   0   &  -1\\ -->
<!-- \end{bmatrix} -->
<!-- \begin{bmatrix} -->
<!-- w_1 \\ -->
<!-- w_2\\ -->
<!-- w_3\\ -->
<!-- w_4\\ -->
<!-- w_5\\ -->
<!-- w_6\\ -->
<!-- \end{bmatrix} \ge \n -->
<!-- \begin{bmatrix} -->
<!-- 1 & 0.01 & 0.01 & 0.01 & 0.01 & 0.01 & 0.01 & -0.25 & -0.25 & -0.25 & -0.25 & -0.25 & -0.25 & -0.25 & -0.25 &  -0.60 & -0.60 & -0.60 -->
<!-- \end{bmatrix} -->


Moving to risk parity, the portfolio setup involves optimizing risk contribution through weight allocations, ensuring proportional risk distribution among assets. The process for equalizing risk contributions is delineated, highlighting the attempt to balance risks across the portfolio [@RPP].

The volatility of the portfolio $\sigma(\boldsymbol{w})=\sqrt{\boldsymbol{w^t\Sigma w}}$, the risk contribution of the $i$th asset to the total risk is defined as: 

$RC_i=\frac{w_i((\boldsymbol{\Sigma w}))i}{\sqrt{\boldsymbol{w^t\Sigma w}}}$ which satisfies $\sum_{i=1}^{N} RC_i = \sigma(\boldsymbol{w})$. The relative or marginal risk contribution (RRC) is a normalized version so that $\sum_{i=1}^{N} RRC_i = 1$.

Therefore the risk parity profile which attempts to equalize the risk contributions is: $RC_i=\frac{1}{N}\sigma (\boldsymbol{w})$

The risk budget constraint attempts to allocate the risk according to the risk profile determined by the weights $\boldsymbol{b}$ (with $\boldsymbol{1}^T \boldsymbol{b} =1$ and $\boldsymbol{b} \ge 0$) so that it can be expressed as $RC_i=b_i\sigma (\boldsymbol{w})$

For the \textnormal{na\"{i}ve} diagonal formulation the constraints are $\boldsymbol{1}^T \boldsymbol{w} =1$ and $\boldsymbol{w} \ge 0$) which will state that the portfolio is inversely proportional to the assets' volatilities. Mathematically,

\begin{align}
\boldsymbol{w} =\frac{\boldsymbol{\sigma}^{-1}}{\boldsymbol{1}^T \boldsymbol{\sigma}^{-1}}
\end{align}

where $\boldsymbol{\sigma^2}=Diag(\boldsymbol{\Sigma})$. Therefore, lower weights are given to high volatility assets and higher weights to low volatility assets. This is often referred to as "equal volatility" portfolio. Creating an "equal volatility" portfolio involves selecting and assigning weights to individual assets in such a way that, when combined, each asset's volatility contributes equally to the total volatility of the portfolio. This approach aims to mitigate the impact of any single asset's volatility on the overall risk of the portfolio, potentially providing a more diversified and risk-balanced investment strategy. $sd(w_i r_i)=w_i \sigma_i=\frac{1}{N}$


Adding the additional constraints we get:

\begin{align}
\min_{w}\ R(\boldsymbol{w}) + \lambda F(\boldsymbol{w})  \\
s.t.\ \boldsymbol{Cw}=\boldsymbol{c}, \boldsymbol{Dw}\le\boldsymbol{d}
\end{align}

# Results \label{-}

## Preliminary analysis
This section examines the risk contribution, weight allocation, and cumulative returns of each portfolio. While offering insights into expected portfolio behavior, it is essential to recognize that this analysis alone may not comprehensively assess portfolio performance. A more robust and detailed analysis follows this section.

Figure \ref{Figure1} illustrates the expected weight allocation of the Risk Parity portfolio, aligning with its relative risk contributions. In contrast, the Minimum Variance Portfolio (MVP) portfolio exhibits an inverse relationship, with a greater risk contribution corresponding to a smaller weight allocation. A similar trend is observed in the MVO portfolio, with variations. The Risk Parity Portfolio, notable for its diverse allocation, particularly allocates a significant weight to the 'ALBI' asset class, showcasing the intuitive nature of the Risk Parity strategy. Conversely, the MVP portfolio, while aggressively targeting equities and gold, overlooks 'J433' and aligns with the traditional weight distribution of minimum variance, concentrating heavily on low-risk asset classes such as bonds [@lohre2014diversifying].

Figure \ref{Figure1} also provides insights into the investment risk profiles of different portfolios, revealing key exposures for each asset class. Global bonds face currency risk, while local equities are subject to market risk influenced by economic conditions, geopolitical events, and investor sentiment. Global equities are exposed to global market movements, economic conditions, currency risk, and political and regulatory risk. The Risk Parity portfolio demonstrates the highest exposure to both local and global equities, indicating sensitivity to global market dynamics. In contrast, the MVP Portfolio has a greater emphasis on global and local bonds.

A higher weight allocation to bonds in a portfolio offers several benefits. Bonds are generally less volatile than equities, contributing to a more stable portfolio value, which is suitable for risk-averse investors. Bonds also provide regular interest payments, creating a predictable income stream. Additionally, bonds are considered safer in terms of capital preservation, offering a hedge during equity market downturns. The lower correlation between bonds and equities contributes to diversification, reducing overall portfolio risk.

On the other hand, the Mean-Variance Optimization (MVO) exhibits a higher exposure to the gold spot rate and local stocks. This suggests that gold serves as a potential protective buffer, employed for hedging against inflation risk and mitigating market and economic stress.

Figure \ref{Figure2} compares cumulative returns across portfolio strategies, highlighting MVO and Risk Parity as prominent contenders. 

```{r}
#create portfolio rebalancing quarterly


DT <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name) #data to be used

weights <- plotdf %>%  group_by(date) %>% 
  
  mutate(Weights = 1/n())


weights_ew_new <-weights%>%  mutate(Weights=as.numeric(as.character(Weights))) %>% filter(format(date, "%m-%d") %in% c("03-31", "06-30", "09-30", "12-31")) 
 
weights_ew_final <- weights_ew_new %>% tbl_xts(., cols_to_xts = Weights, spread_by = Name)

Portfolio_EW <-  Safe_Return.portfolio(R = DT, weights = weights_ew_final, rebalance_on = "quarter", verbose=T)

EW_portfolio_return_weighted <- 
   Portfolio_EW$returns %>% xts_tbl()%>% rename("portfolio.returns_EW"=portfolio.returns)

# # Below using BOP gives same results as above if you use Portfolio_EW$returns
# 
# # Clean and save portfolio returns and weights:
# W_Contribution <- 
#       Portfolio_EW$contribution %>% xts_tbl() 
# 
# W_BPWeight <- 
#       Portfolio_EW$BOP.Weight %>% xts_tbl()  
# 
# W_BPValue <- 
#       Portfolio_EW$BOP.Value %>% xts_tbl()
# 
#   
#     names(W_Contribution) <- c("date", names(Portfolio_EW$contribution))
#     names(W_BPWeight) <- c("date", names(Portfolio_EW$BOP.Weight))
#     names(W_BPValue) <- c("date", names(Portfolio_EW$BOP.Value))
# 
# W_BPWeight <- W_BPWeight %>% gather(Name, Weight, -date)
# W_BPValue<- W_BPValue %>% gather(Name, value_held, -date)
# W_Contribution <- W_Contribution %>% gather(Name, Contribution, -date)
# 
# names_to_replace <- c("GlobalAgg.Unhedged.USD","Gold.Spot...Oz..GOLDS.COMDTY.","MSCI.ACWI","SP.500")
#   # Names to be replaced
# new_names <- c("GlobalAgg Unhedged USD", "Gold Spot $/Oz (GOLDS COMDTY)", "MSCI ACWI", "SP 500")               # New names
# 
# # Replace specific column names
# W_BPWeight <- W_BPWeight %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# W_BPValue <-  W_BPValue %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# W_Contribution <- W_Contribution %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# DATA <- plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31")
# EW_portfolio_and_weight <- 
#       left_join(DATA,
#                 W_BPWeight,
#                 by = c("date", "Name") )



# Plotting the cumulative returns of porfolio construction according to the "Naive" portfolio weigths
# Calculate Portfolio Returns:



Cum_EW <- 
EW_portfolio_return_weighted %>%  
    mutate(cumreturn_EW = (cumprod(1 + portfolio.returns_EW ))) %>% 
    mutate(cumreturn_EW = cumreturn_EW / first(cumreturn_EW)) %>% select(-portfolio.returns_EW)


```


```{r}
# Porfolio construction using Minimum Variance Portfolio

# The portfolio is subject to quarterly rebalancing to maintain alignment with predefined exposure thresholds, including a 25% limit on Bonds,credit instruments and commodoties, a maximum of 60% exposure to Equities, and a cap of 40% on single asset exposure. Utilizing monthly data, a
# covariance matrix has been estimated using datasets available post-2010 for analytical purposes.


# first use method in class then compare it with method found on Google

library(PortfolioAnalytics)
#now what it the optimal weight of each equity? remember that the "limit exposure" instruction is how I am going to cap my porfolio

#Getting optimal weights via Portfolio Optimization
return_mat <- plotdf  %>% filter (date>="2002-02-28" & date<="2023-08-31") %>% select(date, Name, Returns) %>% spread(Name, Returns)

# is there any NAs?
# source("/Users/gabriellaneilon/Library/Mobile Documents/com~apple~CloudDocs/Masters/22581340_Financial-Econometrics/22581340_FE/code/Impute_NA_Returns.R")
# impute_missing_returns(return_mat, impute_returns_method = "None") 
# No Nas!!

# Drop date column for this...
return_mat_Nodate <- data.matrix(return_mat[, -1])

# Simple Sample covariance and mean:
#for safety to avoid the impact of outliers
# Ledoit Wolf shrinkage:
Sigma_LW <- RiskPortfolios::covEstimation(return_mat_Nodate, control = list(type = "lw"))
Mu <- return_mat %>% summarise(across(-date, ~prod(1+.)^(1/n())-1)) %>% purrr::as_vector()
# Purely for safety reasons, to avoid a non-positive definite matrix breaking your function...
Sigma <- as.matrix( Matrix::nearPD(Sigma_LW)$mat)

#Now let's begin with other constraints to design Amat and bvec

NStox <- ncol( return_mat_Nodate )
LB = 0.01
UB = 0.25
meq = 1 # as only the first column of Amat is an equality (weight sum equals 1)

# Additional constraints
bond_credit_limit <- 0.25
equities_limit <- 0.60
commodity_limit <- 0.1



# Define the new order of asset classes
#new_order <- c("bond", "bond", "commodity", "equity")

eq_const_mat<-  rbind(matrix(0, nrow = 3, ncol = 2),
                    -diag(2))


bond_const_mat <- rbind(matrix(0, nrow = 0, ncol = 2),
                     -diag(2),
                     matrix(0, nrow = 3, ncol = 2))

commodity_const_mat <- rbind(matrix(0, nrow = 2, ncol = 1),
                -1,
                matrix(0, nrow = 2, ncol = 1))


bvec <- c( 1, rep(LB, NStox), -rep(UB, NStox), -rep(bond_credit_limit, 2), -rep(commodity_limit,1), -rep(equities_limit, 2))


Amat <- cbind(1, diag(NStox), -diag(NStox),-bond_const_mat,commodity_const_mat ,eq_const_mat )
  # Adjustment for the equities limit
  
# we will use the quadprog package" to get MVP
  w.opt <- 
    quadprog::solve.QP(Dmat = Sigma,
                            dvec = Mu, 
                            Amat = Amat, 
                            bvec = bvec, 
                            meq = meq)$solution

 result.QP <- tibble(stocks = colnames(Sigma), weight = w.opt) 
 
# ###############
# #MVo
#     quadprog::solve.QP(Dmat = Sigma,
#                             dvec = Mu, 
#                             Amat = t(Amat), 
#                             bvec = bvec, 
#                             meq = meq)$solution
 
##############
Type_minvol = "minvol"
      Opt_W_min_vol <- 
        RiskPortfolios::optimalPortfolio(mu = Mu, Sigma = Sigma, 
                control = list(type = Type_minvol, constraint = 'user', 
                               LB = rep(LB, ncol(Sigma)), 
                               UB = rep(UB, ncol(Sigma)),
             bond_credit_limit=-rep(bond_credit_limit,2),
                commodity_limit=rep(commodity_limit, 1),
                equities_limit=rep(equities_limit,2)))

      
# now for mean variance
 Type_mv = "mv"
      Opt_W_mv <- 
        RiskPortfolios::optimalPortfolio(mu = Mu, Sigma = Sigma, 
                control = list(type = Type_mv, constraint = 'user', 
                               LB = rep(LB, ncol(Sigma)), 
                               UB = rep(UB, ncol(Sigma)),
             bond_credit_limit=rep(bond_credit_limit,ncol(Sigma)),
                commodity_limit=rep(commodity_limit, ncol(Sigma)),
                equities_limit=rep(equities_limit,ncol(Sigma))))  
      
# erc?
      
Type_erc = "erc"
      Opt_W_erc <- 
        RiskPortfolios::optimalPortfolio(mu = Mu, Sigma = Sigma, 
                control = list(type = Type_erc, constraint = 'user', 
                               LB = rep(LB, ncol(Sigma)), 
                               UB = rep(UB, ncol(Sigma)),
             bond_credit_limit=rep(bond_credit_limit,ncol(Sigma)),
                commodity_limit=rep(commodity_limit, ncol(Sigma)),
                equities_limit=rep(equities_limit,ncol(Sigma)))) 
      

```

```{r}
# Using alternative method in practical using  CVXR package to see if the results are the same
# pacman::p_load(CVXR)
# 
# w <- Variable(NStox)
# ret <- t(Mu) %*% w
# risk <- quad_form(w, Sigma)
# obj <- ret - risk
# constr <- list(w >= LB, w <= UB, sum(w) == 1, w <= 0.25,w<= 0.60)
# #constr <- list(p_norm(w,1) <= Lmax, sum(w) == 1)
# prob <- Problem(Maximize(obj), constr)
# result <- solve(prob)
# result.CVXR <- tibble(stocks = colnames(Sigma), weight = result$getValue(w) %>% as.vector())

# I get the same results



#Type = "minvol"
#RiskPortfolios::optimalPortfolio(mu = Mu, Sigma = Sigma, 
                # control = list(type = Type, constraint = 'user', 
                #                LB = rep(LB, ncol(Sigma)), 
                #                UB = rep(UB, ncol(Sigma)),
                #                bond_credit_limit = rep(bond_credit_limit,ncol(Sigma)),
                #                equities_limit = rep(equities_limit, ncol(Sigma))))
```

```{r}
# LB = 0.01
# UB = 0.25
# meq = 1 # as only the first column of Amat is an equality (weight sum equals 1)
# 
# # Additional constraints
# bond_credit_limit <- 0.25
# equities_limit <- 0.60
# 
# # Using function from class (NB: remember to put into differents files for final)
# 
# optim_foo <- function(Type = "mv", Mu, Sigma, LB, UB, bond_credit_limit,commodity_limit, equities_limit,printmsg = TRUE){
# 
#   Safe_Optim <- purrr::safely(RiskPortfolios::optimalPortfolio)
#         
# Opt_W <- 
#         Safe_Optim(mu = Mu, Sigma = Sigma, 
#                 control = list(type = Type, constraint = 'user', 
#                                LB = rep(LB, ncol(Sigma)), 
#                                UB = rep(UB, ncol(Sigma)),
#                                bond_credit_limit = rep(bond_credit_limit,ncol(Sigma)),
#                                commodity_limit=rep(commodity_limit, ncol(Sigma)),
#                                equities_limit = rep(equities_limit, ncol(Sigma))))
# 
# if( is.null(Opt_W$error)){
#   
#   optimw <- 
#     tibble(Tickers = colnames(Sigma), weights = Opt_W$result) %>% 
#     # Take note:
#     rename(!!Type := weights)
#   
#   if(printmsg)   optimw <- optimw %>% mutate(Result = glue::glue("Converged: {Type}"))
#   
# } else {
#   
#   optimw <- tibble(Tickers = colnames(Sigma), weights = 1/ncol(Sigma)) %>% 
#     # Take note:
#     rename(!!Type := weights)
# 
#  
#   if(printmsg)   optimw <- optimw %>% mutate(Result = glue::glue("Failed to Converge: {Type}"))
#   
# }
#      optimw
# }
# 
# 
# # apply function
# My_Weights <- left_join(
#   optim_foo(Type = "mv", Mu, Sigma, LB, UB ,bond_credit_limit, commodity_limit,equities_limit, printmsg = F),
#   optim_foo(Type = "minvol", Mu, Sigma, LB, UB, bond_credit_limit, equities_limit, printmsg = F),
#   by = c("Tickers")) %>% 
#     left_join(.,optim_foo(Type = "erc", Mu, Sigma, LB, UB, bond_credit_limit,commodity_limit, equities_limit, printmsg = F),by = c("Tickers")) %>% 
#       left_join(.,optim_foo(Type = "riskeff", Mu, Sigma, LB, UB , bond_credit_limit, commodity_limit,equities_limit, printmsg = F),by = c("Tickers"))
#   
# 
# 
# 
# 
# # Function from class
# EOM_datevec <- return_mat %>% select(date) %>% unique %>% mutate(YM = format(date, "%Y%B")) %>% group_by(YM) %>% filter(date == last(date)) %>% ungroup() %>% pull(date) %>% unique
# 
# Roll_optimizer <- function(return_mat, EOM_datevec, LookBackSel = 36){
#   
# return_df_used <- return_mat %>% filter(date >= EOM_datevec %m-% months(LookBackSel))
#   
# if(return_df_used %>% nrow() < LookBackSel) return(NULL) # PRO TIP - return NULL effectively skips the iteration when binding....
# 
# return_mat_Nodate <- data.matrix(return_df_used[, -1])
# # Simple Sample covariance and mean for the lookback period:
# Sigma <- RiskPortfolios::covEstimation(return_mat_Nodate)
# Mu <- return_mat %>% summarise(across(-date, ~prod(1+.)^(1/n())-1)) %>% purrr::as_vector()
# 
# 
# My_Weights <- 
#   left_join(
#   optim_foo(Type = "mv", Mu, Sigma, LB, UB, bond_credit_limit, commodity_limit,equities_limit, printmsg = F),
#   optim_foo(Type = "minvol", Mu, Sigma, LB, UB, bond_credit_limit, equities_limit, printmsg = F),
#   by = c("Tickers")) %>% 
#     left_join(.,optim_foo(Type = "erc", Mu, Sigma, LB, UB, bond_credit_limit, equities_limit, printmsg = F),by = c("Tickers")) %>% 
#       left_join(.,optim_foo(Type = "riskeff", Mu, Sigma, LB, UB, bond_credit_limit, equities_limit, printmsg = F),by = c("Tickers")) %>% 
#   
#   mutate(date = EOM_datevec, Look_Back_Period = LookBackSel)
#   
# }
```

```{r}
All_Result <- data.frame(cbind(Name=colnames(Sigma),minvol=Opt_W_min_vol,mv=Opt_W_mv, erc=Opt_W_erc)) 

assign_weights <- function(df, weights) {
  df$Weights <- weights[match(df$Name, unique(df$Name))]
  return(df)
}

# Apply weights to return_mat_plot based on asset names
weighted_minvol <- return_mat %>% gather(Name,Returns,-date) %>% 
  group_by(date) %>%
  mutate(Weights = ifelse(row_number() <= length(All_Result$minvol), All_Result$minvol[row_number()], NA))

weights_minvol_new <- weighted_minvol[,c(1,2,4)]

weights_minvol_new <-weights_minvol_new %>%  mutate(Weights=as.numeric(as.character(Weights))) %>% filter(format(date, "%m-%d") %in% c("03-31", "06-30", "09-30", "12-31")) 
 
weights_minvol_final <- weights_minvol_new %>% tbl_xts(., cols_to_xts = Weights, spread_by = Name)



Portfolio_MinVol <-  Safe_Return.portfolio(R = DT, weights = weights_minvol_final,  verbose=T)


Weighted_Porfolio_Returns_MinVol <- 
      Portfolio_MinVol$returns %>% xts_tbl() %>% rename("portfolio.returns_MinVol"=portfolio.returns)#This gives same returns as below process, ut I had to make sure it correlated

# W_BPWeight <- 
#       Portfolio_MinVol$BOP.Weight %>% xts_tbl()  
# 
# 
#   
# 
#     names(W_BPWeight) <- c("date", names(Portfolio_MinVol$EOP.Weight))
# 
# 
# W_BPWeight <- W_BPWeight %>% gather(Name, Weight, -date)
# 
# 
# 
# names_to_replace <- c("GlobalAgg.Unhedged.USD","Gold.Spot...Oz..GOLDS.COMDTY.","MSCI.ACWI","SP.500")
#   # Names to be replaced
# new_names <- c("GlobalAgg Unhedged USD", "Gold Spot $/Oz (GOLDS COMDTY)", "MSCI ACWI", "SP 500")               # New names
# 
# # Replace specific column names
# W_BPWeight <- W_BPWeight %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# 
# 
# EW_portfolio_and_weight <- 
#       left_join(DATA,
#                 W_BPWeight,
#                 by = c("date", "Name") )
# 
#  EW_portfolio_and_weight%>% group_by(date) %>% summarise(PortfolioReturn = sum(Returns*Weight, na.rm =TRUE)) %>% 
#       filter(PortfolioReturn != 0)






##

Cum_MinVol <-
Weighted_Porfolio_Returns_MinVol%>%
    mutate(cumreturn_minvol = (cumprod(1 + portfolio.returns_MinVol))) %>%
    mutate(cumreturn_minvol= cumreturn_minvol/ first(cumreturn_minvol)) %>% select(-portfolio.returns_MinVol)
```


```{r}
##
# Now for MV
weighted_mv <- return_mat %>% gather(Name,Returns,-date) %>% 
  group_by(date) %>%
  mutate(Weights = ifelse(row_number() <= length(All_Result$mv), All_Result$mv[row_number()], NA))

weights_mv_new <- weighted_mv[,c(1,2,4)]
weights_mv_new <-weights_mv_new %>%  mutate(Weights=as.numeric(as.character(Weights))) %>% filter(format(date, "%m-%d") %in% c("03-31", "06-30", "09-30", "12-31")) 

 
weights_mv_final <- weights_mv_new %>% tbl_xts(., cols_to_xts = Weights, spread_by = Name)


Portfolio_MV <-  Safe_Return.portfolio(R = DT, weights = weights_mv_final, rebalance_on = "quarter", verbose=T)


Weighted_Porfolio_Returns_MV <- 
      Portfolio_MV$returns %>% xts_tbl()%>% rename("portfolio.returns_MV"=portfolio.returns)

Cum_MV <-
Weighted_Porfolio_Returns_MV%>%
    mutate(cumreturn_mv = (cumprod(1 + portfolio.returns_MV))) %>%
    mutate(cumreturn_mv= cumreturn_mv/ first(cumreturn_mv)) %>% select(-portfolio.returns_MV)





```



```{r}
# This section I'm testing something out

#NBNBNB this is only for testing
# weights_mv <- All_Result[,c(6,1,2)]
# 
# weights_new_mv <- weights_mv %>% tbl_xts(., cols_to_xts = mv, spread_by = Name)
# DT_MV <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name)
# Portfolio_mv<-  Safe_Return.portfolio(R = DT_MV, weights = weights_new_mv, rebalance_on = "quarter",verbose=T)
# 
# 
# weighted_Porfolio_Returns_mv <-
#       Portfolio_mv$returns %>% xts_tbl()
# 
# Cum_mv <-
# weighted_Porfolio_Returns_mv%>%
#     mutate(cumreturn_mv = (cumprod(1 + portfolio.returns))) %>%
#     mutate(cumreturn_mv= cumreturn_mv/ first(cumreturn_mv)) %>% select(-portfolio.returns)
# # 
# # #####################################
# wts_erc <- All_Result[,c(6,1,4)]
# 
# wts_new_erc <- wts_erc %>% tbl_xts(., cols_to_xts = erc, spread_by = Name)
# 
# DT_erc <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name)
# Portfolio_erc <-  Safe_Return.portfolio(R = DT_erc, weights = wts_new_erc, rebalance_on = "quarter",verbose=T)
# 
# 
# erc_Porfolio_Returns <-
#       Portfolio_erc$returns %>% xts_tbl()
# 
# Cum_erc <-
# erc_Porfolio_Returns%>%
#     mutate(cumreturn_erc = (cumprod(1 + portfolio.returns))) %>%
#     mutate(cumreturn_erc= cumreturn_erc / first(cumreturn_erc)) %>% select(-portfolio.returns)


# 
# #################################
# 
# wts_riskeff <- MV_Result[,c(6,1,5)]
# 
# wts_new_riskeff <- wts_riskeff %>% tbl_xts(., cols_to_xts = riskeff, spread_by = Name)
# 
# DT_riskeff <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name)
# Portfolio_riskeff <-  Safe_Return.portfolio(R = DT_riskeff, weights = wts_new_riskeff, rebalance_on = "quarter",verbose=T)
# 
# 
# riskeff_Porfolio_Returns <- 
#       Portfolio_riskeff$returns %>% xts_tbl() 
# 
# Cum_riskeff <-
# riskeff_Porfolio_Returns%>%
#     mutate(cumreturn_riskeff = (cumprod(1 + portfolio.returns))) %>%
#     mutate(cumreturn_riskeff= cumreturn_riskeff / first(cumreturn_riskeff)) %>% select(-portfolio.returns)
# 
# ######################
# 
# 
# data1_t <- left_join(Cum_mv,Cum_mv_mv, by="date")
# 
# data2_t <- left_join(data1_t, Cum_erc, by="date")
# 
# data3_t <- left_join(data2_t, Cum_riskeff, by="date")
# 
# data4_t <- data3_t %>% gather(CumReturnType, Value, -date)
# 
# 
# plot1_t <- data4_t %>% ggplot() +
# geom_line(aes(date, Value, color = CumReturnType), alpha = 0.7,
#     size = 1) +
# labs(title = "Rolling 3 Year Annualized Returns of Indices",
#     subtitle = "", x = "", y = "Rolling 3 year Returns (Ann.)",
#     caption = "Note:\nIndustry Index is a basic calculation for grouping together the comparative industries for better comparisons") + theme_fmx(title.size = ggpts(30),
#     subtitle.size = ggpts(5), caption.size = ggpts(25), CustomCaption = T) +
# 
# fmx_cols()
# 
# g_finplot_t <- finplot(plot1_t, x.date.dist = "1 year", x.date.type = "%Y", x.vert = T,
#     y.pct = T, y.pct_acc = 1)
```



```{r}
# Now calculate rebalanvce quarterly and calculate the return of it based on the minvol 


# #NBNBNB use this one
# weights_minvol <- All_Result[,c(6,1,3)]
# 
# weights_new_minvol <- weights_minvol %>% tbl_xts(., cols_to_xts = minvol, spread_by = Name)
# DT_MinVol <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name)
# Portfolio_MinVol <-  Safe_Return.portfolio(R = DT_MinVol, weights = weights_new_minvol, rebalance_on = "quarter",verbose=T)
# 
# DATA <- plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31")
# # Clean and save portfolio returns and weights:
# W_Contribution_MinVol <- 
#       Portfolio_MinVol$contribution %>% xts_tbl() 
# 
# W_BPWeight_MinVol <- 
#       Portfolio_MinVol$BOP.Weight %>% xts_tbl()  
# 
# W_BPValue_MinVol <- 
#       Portfolio_MinVol$BOP.Value %>% xts_tbl()
# 
#   
#     names(W_Contribution_MinVol) <- c("date", names(Portfolio_MinVol$contribution))
#     names(W_BPWeight_MinVol) <- c("date", names(Portfolio_MinVol$BOP.Weight))
#     names(W_BPValue_MinVol) <- c("date", names(Portfolio_MinVol$BOP.Value))
# 
# W_BPWeight_MinVol<- W_BPWeight_MinVol %>% gather(Name, Weight, -date)
# W_BPValue_MinVol<- W_BPValue_MinVol %>% gather(Name, value_held, -date)
# W_Contribution_MinVol <- W_Contribution_MinVol %>% gather(Name, Contribution, -date)
# 
# names_to_replace <- c("GlobalAgg.Unhedged.USD","Gold.Spot...Oz..GOLDS.COMDTY.","MSCI.ACWI","SP.500")
#   # Names to be replaced
# new_names <- c("GlobalAgg Unhedged USD", "Gold Spot $/Oz (GOLDS COMDTY)", "MSCI ACWI", "SP 500")               # New names
# 
# # Replace specific column names
# W_BPWeight_MinVol <- W_BPWeight_MinVol %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# W_BPValue_MinVol<-  W_BPValue_MinVol %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# W_Contribution_MinVol <- W_Contribution_MinVol %>%
#   mutate(Name = ifelse(Name %in% names_to_replace, new_names[match(Name, names_to_replace)], Name))
# 
# 
# portfolio_return_MinVol <- 
#       left_join(DATA,
#                 W_BPWeight_MinVol,#dont know if this is significant
#                 by = c("date", "Name") ) %>% 
#       
#       left_join(.,
#                 W_BPValue_MinVol,
#                 by = c("date", "Name") ) %>% 
#       
#       left_join(.,
#                 W_Contribution_MinVol,
#                 by = c("date", "Name"))
# 
# # Rebalance_Quarterly <- 
# #   
# #   return_mat %>% 
# #   
# #   mutate(Year = format(date, "%Y"), Month = format(date, "%b"), Day = format(date, "%a")) %>% 
# #   
# #   dplyr::filter(Month %in% c("Mar", "Jun", "Sep", "Dec")) %>% 
# #   
# #   select(date, Year,  Month, Day ) %>% unique() %>% 
# #   
# #   group_by(Year, Month) %>% 
# #   
# #   filter( date == last(date)) %>% 
# #   
# #   pull(date)
# 
# 
# # new_dat_MV %>% group_by(date) %>% summarise(PortfolioReturn = sum(Returns*minvol, na.rm =TRUE)) %>% 
# #       filter(PortfolioReturn != 0) #gives same results
# 
# weighted_returns_porfolio_MinVol <- 
#     All_Result_new %>% group_by(date) %>% summarise(PortfolioReturn = sum(Returns*minvol, na.rm =TRUE)) %>% 
#       filter(PortfolioReturn != 0)
# 
# 
# Cum_minvol <- 
# weighted_returns_porfolio_MinVol%>% 
#     mutate(cumreturn_minvol = (cumprod(1 + PortfolioReturn))) %>% 
#     mutate(cumreturn_minvol= cumreturn_minvol / first(cumreturn_minvol)) %>% select(-PortfolioReturn)
```


```{r}
# Lastly look at Risk Parity Portfolio
# 
# From what I understand in this construction you need to calculate the covariance matrix by doing the following: 
# I first need to get a vector of the volatility of each asset class
# then get a correlation matrix between the asset classes


library("riskParityPortfolio")
#Getting optimal weights via Portfolio Optimization
return_mat <- plotdf  %>% filter (date>="2002-02-28" & date<="2023-08-31") %>% select(date, Name, Returns) %>% spread(Name, Returns)

# is there any NAs?
# source("/Users/gabriellaneilon/Library/Mobile Documents/com~apple~CloudDocs/Masters/22581340_Financial-Econometrics/22581340_FE/code/Impute_NA_Returns.R")
# impute_missing_returns(return_mat, impute_returns_method = "None") 
# No Nas!!

# Drop date column for this...
return_mat_Nodate <- data.matrix(return_mat[, -1])
vol <- return_mat %>% summarise(across(-date, ~var(.) %>% purrr::as_vector())) 
vol <- c(0.0004533727,0.000297337,0.002291268,0.001893842,0.002066549)
# Simple Sample covariance and mean:
#for safety to avoid the impact of outliers
# Ledoit Wolf shrinkage:
cov<- RiskPortfolios::covEstimation(return_mat_Nodate, control = list(type = "lw"))
Mu <- return_mat %>% summarise(across(-date, ~prod(1+.)^(1/n())-1)) %>% purrr::as_vector()
# Purely for safety reasons, to avoid a non-positive definite matrix breaking your function...
corr <- round(cor(return_mat[,2:6], method = "pearson", use = "complete.obs"),4)

sigma <- corr * (vol %o% vol) #according to rstudio method, NB ask if you should rather do it like this
Sigma <- as.matrix( Matrix::nearPD(cov)$mat) #gives same results

#define linear constraints

Dmat <- matrix(0, 5, 5) # five: for the 5 asset classes and 5: for the number of constraints (will be using the same constraints as in the min variance) 
# constraints: 1. UB, LB, bond, commodity,equity
Dmat[1, ] <- c(rep(0, 3), rep(-1, 2))
Dmat[2, ] <- c(rep(0, 2), rep(-1, 1), rep(0,2))
Dmat[3, ] <- c(rep(-1, 2), rep(0,3))
Dmat[4, ] <-rep(-1,5)
Dmat[5,] <- rep(-1,5)

dvec <- c(-0.6, -0.1, -0.25,-0.25, 0.01)



# design portfolio
rpp <- riskParityPortfolio(Sigma, Dmat = Dmat, dvec = dvec)


# plot portfolio weights
# barplotPortfolioRisk(rpp$w, Sigma)

#check to see if constraints sum to one
#print(sum(rpp$w))
# library(RiskPortfolios)
# optimalPortfolio(Sigma = Sigma,
#                                control = list(type = "erc",
#   


```


```{r}
# plotting cumulative returns

# return_mat_plot <- return_mat %>% filter(date %in%  Rebalance_Quarterly) %>% gather(Name, Returns, -date)

weights_rp<- c("GlobalAgg Unhedged USD"= 3.574634e-08,"Gold Spot $/Oz (GOLDS COMDTY)"=1.500000e-01 ,"MSCI ACWI"= 2.941502e-01 ,"J433"=3.058498e-01 , "ALBI"= 2.500000e-01 )

assign_weights <- function(df, weights) {
  df$Weights <- weights[match(df$Name, unique(df$Name))]
  return(df)
}

# Apply weights to return_mat_plot based on asset names
t <- return_mat %>% gather(Name,Return,-date) %>% 
  group_by(date) %>%
  mutate(Weights = ifelse(row_number() <= length(weights_rp), weights_rp[row_number()], NA))

weights_rp_new <- t[,c(1,2,4)]

weights_rp_new <-weights_rp_new %>%  mutate(Weights=as.numeric(as.character(Weights))) %>% filter(format(date, "%m-%d") %in% c("03-31", "06-30", "09-30", "12-31")) 
 
weights_rp_final <- weights_rp_new %>% tbl_xts(., cols_to_xts = Weights, spread_by = Name)

DT <-  plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31") %>% tbl_xts(., cols_to_xts = Returns, spread_by = Name)

Portfolio_RP <-  Safe_Return.portfolio(R = DT, weights = weights_rp_final, rebalance_on = "quarter", verbose=T)

DATA <- plotdf%>% filter (date>="2002-02-28" & date<="2023-08-31")

RP_Porfolio_Returns <- 
      Portfolio_RP$returns %>% xts_tbl() %>% rename("portfolio.returns_RP"=portfolio.returns) 


#####################

Cum_RP <-
RP_Porfolio_Returns%>%
    mutate(cumreturn_rp = (cumprod(1 + portfolio.returns_RP))) %>%
    mutate(cumreturn_rp= cumreturn_rp / first(cumreturn_rp)) %>% select(-portfolio.returns_RP)
# 
# 
# MV_Porfolio_Returns <- 
#       Portfolio_MV$returns %>% xts_tbl() 
# 
# Cum_mvv <-
# MV_Porfolio_Returns%>%
#     mutate(cumreturn_mvv = (cumprod(1 + portfolio.returns))) %>%
#     mutate(cumreturn_mvv= cumreturn_mvv / first(cumreturn_mvv)) %>% select(-portfolio.returns)
# 
# data1_t <- left_join(Cum_mvv,Cum_W, by="date")
# 
# data2_t <- left_join(data1_t, Cum, by="date")
# 
# data3_t <- data2_t %>% gather(CumReturnType, Value, -date)
# 
# 
# plot1_t <- data3_t %>% ggplot() +
# geom_line(aes(date, Value, color = CumReturnType), alpha = 0.7,
#     size = 1) +
# labs(title = "Rolling 3 Year Annualized Returns of Indices",
#     subtitle = "", x = "", y = "Rolling 3 year Returns (Ann.)",
#     caption = "Note:\nIndustry Index is a basic calculation for grouping together the comparative industries for better comparisons") + theme_fmx(title.size = ggpts(30),
#     subtitle.size = ggpts(5), caption.size = ggpts(25), CustomCaption = T) +
# 
# fmx_cols()
# 
# g_finplot_t <- finplot(plot1_t, x.date.dist = "1 year", x.date.type = "%Y", x.vert = T,
#     y.pct = T, y.pct_acc = 1)

# the same


```

```{r Figure1,  warning =  FALSE, fig.align = 'center', fig.cap = "Relative risk contribution and Weights allocation of different portfolios \\label{Figure1}", fig.ext = 'png', fig.height = 4, fig.width = 7}
#plotting weights risk concentration etc
weights_EW <-  c("US Bond"=0.2, "Gold"=0.2, "MSCI ACWI"=0.2, "ALBI"=0.2, "J433"=0.2) 
weights_minvol_plot <- c("US Bond"=0.25, "Gold"=0.1914959944937, "MSCI ACWI"=0.139207415247347, "ALBI"=0.25, "J433"=0.169296590258953) 
weights_mv_plot <- c("US Bond"=0.01, "Gold"=0.25, "MSCI ACWI"=	0.240000000000001, "ALBI"=	0.249999999999998, "J433"=0.25) 
weight_risk_parity_plot <- c("US Bond"=3.574634e-08, "Gold"=1.500000e-01, "MSCI ACWI"=	2.941502e-01, "ALBI"=	 2.500000e-01, "J433"=3.058498e-01) 
# plot
w_all <- cbind("Risk Parity"  = weight_risk_parity_plot,
               "MVP" =weights_minvol_plot ,
               "MVO"=weights_mv_plot,
             "EW Porfolio"=weights_EW)


barplotPortfolioRisk(w_all, Sigma)


```

```{r Figure2,  warning =  FALSE, fig.align = 'center', fig.cap = "Cumulative Returns \\label{Figure2}", fig.ext = 'png', fig.height = 4, fig.width = 6}
# Now I want to plot everything

data1 <- left_join(Cum_MinVol,Cum_EW, by="date")

data2 <- left_join(data1, Cum_RP, by="date")

data3 <- left_join(data2, Cum_MV, by="date")

data4 <- data3 %>% rename(MVP=cumreturn_minvol, EW=cumreturn_EW,"Risk Parity"=cumreturn_rp, MVO=cumreturn_mv) %>% gather(CumReturnType, Value, -date)

             # New names




plot1 <- data4 %>% ggplot() + 
geom_line(aes(date, Value, color = CumReturnType), alpha = 0.7, 
    size = 1) + 
labs(title = "Cumulative Return of Portfolios", 
    subtitle = "", x = "", y = "Cumulative Return", 
    caption = "Note:\nIndices were used to construct portfolios") + theme_fmx(title.size = ggpts(30), 
    subtitle.size = ggpts(5), caption.size = ggpts(25), CustomCaption = T) + 
    
fmx_cols()

g_finplot <- finplot(plot1, x.date.dist = "1 year", x.date.type = "%Y", x.vert = T, 
    y.pct = T, y.pct_acc = 1)

g_finplot
```
## Further Analysis
A drawdown signifies the extent to which the portfolio declines from its peak value before subsequently recovering. The portfolios were assessed in relation to the S&P 500. While the S&P 500 may not be the ideal benchmark, given that other portfolios are primarily constructed from different market indices, its broad market representation, market-capitalization weighting, diverse industry coverage, liquidity, reputation, and global influence make it the most suitable benchmark for this analysis.

In Figure \ref{Figure3}, several crucial metrics stand out when dissecting this graph. These metrics include the depth, duration, frequency, and recovery periods of drawdowns observed in various portfolios relative S&P 500 index. Notably, the S&P 500 index exhibits the most substantial depth in drawdowns, coupled with the lengthiest recovery periods. This implies that the index not only experiences the most significant loss in value following its peaks but also takes an extended period to recover from these downturns. In contrast, the MVP portfolio displays lower frequency, depth, and duration of drawdowns, indicating comparatively smaller losses in portfolio value and consequently lower risk compared to other portfolios.

The Risk Parity portfolio follows a similar trend to the MVP, albeit with greater depth in drawdowns, though not as pronounced as observed in the S&P 500. This suggests that while the Risk Parity portfolio experiences more significant declines in value during drawdowns, it still maintains a risk profile that is less pronounced than that of the S&P 500. The $\frac{1}{N}$ exhibits the last amoutn of depth in drawdowns, followed by the MVo portfolio. The $\frac{1}{N}$ portfolio demonstrates the least depth in drawdowns, with the MVO portfolio following closely.
```{r Figure3,  warning =  FALSE, fig.align = 'center', fig.cap = "Drawdowns \\label{Figure3}", fig.ext = 'png', fig.height = 4, fig.width = 6}
# Doing tables
merged1 <- merge(RP_Porfolio_Returns, Weighted_Porfolio_Returns_MinVol, by="date")
merged2 <- merge(merged1, Weighted_Porfolio_Returns_MV, by="date")
merged3 <- merge(merged2, EW_portfolio_return_weighted, by="date")

all_portfolios <- merged3 %>% rename("Risk Parity"=portfolio.returns_RP, "MVP"=portfolio.returns_MinVol, "MVO"=portfolio.returns_MV, "EW"=portfolio.returns_EW)
combined_data <- left_join(d1, RSA_indexes, by="date")

risk_free_rate<- combined_data %>% select("date","US 3 Month Libor Rate" ) %>% filter (date>="2016-01-31" & date<="2023-08-31")
sp500 <- combined_data %>% select(date,"SP 500") %>% filter (date>="2002-02-28" & date<="2023-08-31")
spxts <- 
      sp500 %>% 
      tbl_xts() 
portfolio_table <- all_portfolios %>% gather(Portfolio, Return,-date) 
portfolios_sp <- merge(sp500, all_portfolios , by="date") 

chart.Drawdown(portfolios_sp,main = "Drawdowns relative to S&P 500", 
               colorset = (2:7), legend.loc = "bottomleft")




```
Furthermore, I conducted an analysis of the annualized risk-return performance of each portfolio relative to the S&P 500 over five distinct periods. The initial period encompasses the entire dataset, while the second period spans from October 2008, marked by a significant drop in the S&P 500 after reaching its peak. The third period, December 2018, witnessed another downturn attributed to factors such as Donald Trump's trade war with China, global economic slowdown, and concerns about the Federal Reserve's rapid interest rate hikes. Additionally, the year 2020, marked by the onset of the COVID-19 pandemic, and January 2022, following a peak in the S&P 500, represent subsequent periods characterized by geopolitical tensions, the Ukraine war, extensive COVID-related lockdowns in China, interest rate hikes by the US Federal Reserve, and overall economic uncertainty in the US post-pandemic. These chosen periods were deliberately selected since it encapsulated volatile circumstances. 



```{r Figure4,  warning =  FALSE, fig.align = 'center', fig.cap = "Annualized Risk-Return performance of portfolios relative to SP 500 over the entire sample period. \\label{Figure4}", fig.ext = 'png', fig.height = 4, fig.width = 6}

portfolios_sp_xts <- merge(sp500, all_portfolios , by="date") %>% tbl_xts()

chart.RiskReturnScatter(R=portfolios_sp_xts[,c("SP 500", "Risk Parity", "MVP", "MVO", "EW")], colorset=rich8equal, legend.loc = "bottomright", main = "Relative Performance to S&P 500 overall")
```
Figure \ref{Figure4}, the Mean-Variance Optimization (MVO) portfolio emerges with the highest potential return accompanied by moderate risk. Conversely, the Minimum Variance Portfolio (MVP) strategy exhibits the lowest risk but correspondingly the lowest return. Both Equal Weight (EW) and Risk Parity strategies offer a balanced combination of moderate returns and risks, outperforming the S&P 500 to some extent.

Figures \ref{Figure5} through \ref{Figure7} illustrate that the MVO portfolio achieves the highest return but also carries the highest risk relative to the S&P 500 index. Meanwhile, the MVP portfolio features the lowest risk but at the expense of the lowest return. The Risk Parity portfolio showcases a moderate return with higher risk than the MVO portfolio.
```{r Figure5,  warning =  FALSE, fig.align = 'center', fig.cap = "Annualized Risk-return performance of portfolios relative to SP 500 since October 2008 \\label{Figure5}", fig.ext = 'png', fig.height = 4, fig.width = 6}
chart.RiskReturnScatter(R=portfolios_sp_xts['2008-10-01/'][,c("SP 500", "Risk Parity", "MVP", "MVO", "EW")], colorset=rich8equal, legend.loc = "bottomleft", main = "Relative Performance to S&P 500 (2008-10-01)")


```

```{r Figure6,  warning =  FALSE, fig.align = 'center', fig.cap = "Annualized Risk-return performance of portfolios relative to SP 500 since December 2018 \\label{Figure6}", fig.ext = 'png', fig.height = 4, fig.width = 6}

chart.RiskReturnScatter(R=portfolios_sp_xts['2018-12-30/'][,c("SP 500", "Risk Parity", "MVP", "MVO", "EW")], colorset=rich8equal, legend.loc = "bottomright", main = "Relative Performance to S&P 500 (2018-12-31)")
```

```{r Figure7,  warning =  FALSE, fig.align = 'center', fig.cap = "Annualized Risk-return performance of portfolios relative to SP 500 since March 2020 \\label{Figure7}", fig.ext = 'png', fig.height = 4, fig.width = 6}
chart.RiskReturnScatter(R=portfolios_sp_xts['2020-03-01/'][,c("SP 500", "Risk Parity", "MVP", "MVO", "EW")], colorset=rich8equal, legend.loc = "bottomleft", main = "Relative Performance to S&P 500 (2020-03-01)")
```
Examining the portfolios' performance relative to the S&P 500 during a short-term volatile period in Figure \ref{Figure8}, suggests that the portfolios outperform the S&P index. Notably, the MVO portfolio exhibits the highest annualized return with risk levels comparable to those of the $\frac{1}{N}$ and Risk Parity portfolios, albeit with the latter two experiencing lower returns. In contrast, the MVP portfolio performs less favorably among the portfolios.
 
 
During a short-term volatile period depicted in Figure \ref{Figure8}, all portfolios exhibit outperformance compared to the S&P 500. Particularly noteworthy is the MVO portfolio, which not only delivers the highest annualized return but also maintains risk levels similar to the $\frac{1}{N}$ and Risk Parity portfolios, albeit with the latter two experiencing lower returns. In contrast, the MVP portfolio lags behind in performance among the portfolios considered.
```{r Figure8,  warning =  FALSE, fig.align = 'center', fig.cap = "Annualized Risk-return performance of portfolios relative to SP 500 since January 2022 \\label{Figure8}", fig.ext = 'png', fig.height = 4, fig.width = 6}
chart.RiskReturnScatter(R=portfolios_sp_xts['2022-01-01/'][,c("SP 500", "Risk Parity", "MVP", "MVO", "EW")], colorset=rich8equal, legend.loc = "bottomleft", main = "Relative Performance to S&P 500 (2022-01-01)")

```

## Index Statistics

This section comprehensively explores portfolio performance through an in-depth analysis of various metrics, including returns, volatility, expected shortfall, average drawdown, and performance during market upswings and downswings. Notably, the assessment excludes the examination of beta for the portfolios. The rationale for this omission lies in the anticipated and confirmed beta values being less than one, indicative of lower volatility compared to the benchmark due to better diversification. Despite the exclusion of beta, other statistical measures are deemed sufficient for providing a comprehensive overview of the diverse portfolio performances.

```{r LongTable, results = 'asis'}


# Calculating Adjusted Sharpe ratio for each portfolio

portfolio_table <- all_portfolios %>% gather(Portfolio, Return,-date) 




# function for table
portfolios_xts <- portfolio_table %>%  tbl_xts(cols_to_xts = Return, spread_by = Portfolio, Colnames_Exact = T)
spxts <- 
      sp500 %>% filter(date>="2002-03-31") %>% 
      tbl_xts(Colnames_Exact = T) 

Adj_SR_RP <- PerformanceAnalytics::AdjustedSharpeRatio(RP_Porfolio_Returns %>% tbl_xts(), risk_free_rate) %>% round(.,3)
Adj_SR_MV <- PerformanceAnalytics::AdjustedSharpeRatio(Weighted_Porfolio_Returns_MV %>% tbl_xts(), risk_free_rate) %>% round(.,3)
Adj_SR_EW <- PerformanceAnalytics::AdjustedSharpeRatio(EW_portfolio_return_weighted %>% tbl_xts(), risk_free_rate) %>% round(.,3)
Adj_SR_MinVol <- PerformanceAnalytics::AdjustedSharpeRatio(Weighted_Porfolio_Returns_MinVol %>% tbl_xts(), risk_free_rate) %>% round(.,3)

Adj_SR_SP500 <- PerformanceAnalytics::AdjustedSharpeRatio(spxts, risk_free_rate) %>% round(.,3)

Sharpe_data <- data.frame(cbind(Portfolio = c("Info","S&P 500", "Risk Parity","MVP","MVO", "EW"),
      `Adj. Sharpe Ratio` = c("Adj. Sharpe Ratio",Adj_SR_SP500,Adj_SR_RP,Adj_SR_MV,Adj_SR_MinVol, Adj_SR_EW))) %>% pivot_wider(names_from = Portfolio, values_from = Adj..Sharpe.Ratio)

#Calculate annualised returns 
EW_ann_Return <- round(Return.annualized(EW_portfolio_return_weighted, scale = 12, geometric = TRUE),2)
Min_Vol_ann_Return <- round(Return.annualized(Weighted_Porfolio_Returns_MinVol, scale = 12, geometric = TRUE),2)
RP_ann_Return <- round(Return.annualized(RP_Porfolio_Returns, scale = 12, geometric = TRUE),2)
MV_ann_Return <- round(Return.annualized(Weighted_Porfolio_Returns_MV, scale = 12, geometric = TRUE),2)

table_data <- data.frame(cbind(Portfolio = c("Equally Weighted", "Minimum-Variance", "Mean-Variance","Risk Parity"),
      `Returns(Ann.)` = c(EW_ann_Return, Min_Vol_ann_Return, MV_ann_Return,RP_ann_Return),
      `Adj. Sharpe Ratio` = c(Adj_SR_RP,Adj_SR_MV,Adj_SR_MinVol, Adj_SR_EW)))



# gt(table_data) %>%
#   tab_header(
#     title = "Portfolio Performance"
#   ) %>%
#   cols_label(
#     Portfolio = "Portfolio",
#     Returns.Ann..="Returns (Ann.)",
#     Adj..Sharpe.Ratio="Adj.Sharpe Ratio"
#   )%>%
#   
#    tab_footnote( footnote = 'This table displays the standalone performance of the portfolios.',
#                 locations = cells_column_labels(columns = contains('Portfolio'))) 

# Calvulating SD
# EW_ann_SD <- round(StdDev.annualized(EW_portfolio_return_weighted, scale = ),2)
# Min_Vol_ann_SD <- round(StdDev.annualized(Weighted_Porfolio_Returns_MinVol, scale = 12, geometric = TRUE),2)
# RP_ann_SD <- round(StdDev.annualized(RP_Porfolio_Returns, scale = 12, geometric = TRUE),2)
# MV_ann_SD <- round(StdDev.annualized(Weighted_Porfolio_Returns_MV, scale = 12, geometric = TRUE),2)
```

The comparison in Table 1 reveals distinctive characteristics of each strategy. The Minimum-Variance Portfolio (MVP) portfolio, while exhibiting the lowest volatility and pain index, suggesting lower risk, it also leads in terms of the adjusted Sharpe ratio compared to the other portfolios, followed by the Mean-Variance (MVO) portfolio (seen in Table 2), implying potential nefficiency in risk-adjusted returns, aligning with conclusions by @chaves2011risk.

The Risk Parity, along with the MVO, demonstrates superior annualized returns, consistent with the findings of @maillard2010properties. The Risk Parity, MVO, and EW portfolios have a positive and greater than the benchmark excess return statistic, whereas MVP has a negative excess return statistic, it implies that RP, MVO, and EW have generated higher returns than the S&P 500 index over the same period, after adjusting for the risk-free rate, whereas MVP has lagged in this regard

The S&P 500, has the highest cumulative returns, but bears the highest volatility and pain index. On the other hand, the Risk Parity portfolio, with a higher adjusted Sharpe ratio than the S&P 500, suggests potential efficiency in risk-adjusted returns and also exhibits the highest up-down ratio which indicates that the portfolio has a greater ability to capture upside potential while minimizing downside risk. In contrast the MVP has the lowest up-down ratio, followed by the equally weighted portfolio which is unsurprising since these portfolios are constructed to be more conservative. It suggests that these portfolios have a greater focus on capital preservation and downside protection, which also means it has a lower ability to capture upside potential. 

The pain index, a measure of risk in losses, aligns with the drawdown graph in Figure \ref{Figure3} and the average drawdown in Table 1. It reaffirms that the S&P 500 experiences the greatest drawdown, followed by the Risk Parity portfolio, with MVP showing the lowest drawdown.

Examining tracking error and information ratio provides insights into portfolio consistency and effectiveness. The MVO strategy stands out with the lowest tracking error and the highest information ratio, indicates that the portfolio has consistently generated excess returns relative to the benchmark, taking into account the volatility of those returns..MVP exhibits the highest tracking error. Correspondingly, the information ratio suggests that MVP consistently underperforms the benchmark on a risk-adjusted basis, aligning with its lower excess returns and reaffirming the findings in Figure \ref{Figure4}-\ref{Figure8}.

The modified Conditional Value at Risk (CVaR) assesses risk-adjusted performance, representing the expected loss beyond the 95% confidence level. Therefore in the worst 5% of the returns, your average loss of the Risk Parity portfolio is lower than the S&P 500 index. However, again as expected, given the risk-averse nature of the portfolios, MVO and MVP has a smaller expected average loss than the Risk Parity portfolio, but the Equally weighted portfolio has a smaller average loss than the MVO portfolio, and only marginally more than the MVP portfolio.



```{r, results='asis'}
comparison_data <- merge(sp500, all_portfolios , by="date") %>%  gather(Portfolio, Return,-date)
BM <- "S&P 500"
Bm <- "S&P 500"

Hist_comp <- function(funds, BM){
 portfolios_xts <- funds%>%  tbl_xts(cols_to_xts = Return, spread_by = Portfolio, Colnames_Exact = T)
spxts <- 
      sp500 %>% filter(date>="2002-03-31") %>% 
      tbl_xts(Colnames_Exact = T) 
    
Moments_hist <- 
      bind_rows(
        data.frame(Return.cumulative(portfolios_xts)) %>% round(., 3),
        data.frame(Return.annualized(portfolios_xts, scale = 12, geometric = T)) %>% round(., 3),
        data.frame(PerformanceAnalytics::Return.annualized.excess(portfolios_xts,spxts) ) %>% round(., 3),
        data.frame(sd.annualized(portfolios_xts, scale = 12, geometric = T)) %>% round(., 3),
        data.frame(PainIndex(portfolios_xts, scale = 12, geometric = T)) %>% round(., 3),
        data.frame(AverageDrawdown(portfolios_xts, scale = 12)) %>% round(., 3),
        data.frame(fmxdat::Safe_TE(Ra = portfolios_xts, Rb = spxts, scale = 12)) %>% round(., 3),
        data.frame(PerformanceAnalytics::InformationRatio(Ra = portfolios_xts, Rb = spxts)) %>% round(., 3),
        data.frame(PerformanceAnalytics::UpDownRatios(Ra = portfolios_xts, Rb = spxts, method = "Percent", side = "Up")) %>% round(., 3),
        data.frame(PerformanceAnalytics::CVaR(R = portfolios_xts, p = 0.05, method = "modified")) %>% round(., 3)
        ) %>% 
        
        tibble::rownames_to_column("Info") %>%
        mutate(Period = glue::glue("Historical"), Info = c("Cum Returns", "Returns (Ann.)", "Returns Excess (Ann.)", "SD (Ann.)","Pain Index", 
                                                 "Avg DD",  "Tracking Error","Information Ratio",  "Up-Down Ratio", "Modified CVaR")) 
# This line replaces the `.` with a space.
  # Note the forward slashes, as `.` there means everything, `\\.` means a full-stop
  colnames(Moments_hist) <- gsub("\\.", " ", colnames(Moments_hist))

Moments_hist}


Fundselected <- c("SP 500","Risk Parity", "MVP", "MVO", "EW")
Tab_stats_hist <- Hist_comp(comparison_data %>% filter(Portfolio %in% Fundselected),BM)

Make_perc_hist <- 
  c( "Cum Returns", "Returns (Ann.)", "Returns Excess (Ann.)", "SD (Ann.)",
     "Avg DD", "Tracking Error")

Rows_to_Perc_hist <- 
  Tab_stats_hist %>% mutate(RN=row_number()) %>% filter(Info %in% Make_perc_hist) %>% pull(RN)
colnams_hist <- colnames(Tab_stats_hist)
Cols_length_hist <- ncol(Tab_stats_hist)
library(gt)

tab_history <- 
  
  Tab_stats_hist %>% 
  
  gt::gt(groupname_col = 'Period', caption = 'Fund Moments Comparison') %>% 
      tab_header(title = glue::glue("Table 1: Long-Term Index Statistics: Relative to {BM}")) %>% 
      fmt_percent(
      columns = 2:Cols_length_hist,
      rows = Rows_to_Perc_hist,
      decimals = 1
    ) %>%   
  sub_missing(
    columns = all_of(colnams_hist),
    missing_text = '-'
  ) %>%
  
   tab_footnote( footnote = 'Utilising the US 3-Month Libor Rate as a proxy for the risk-free rate',
                locations = cells_column_labels(columns = contains('Info'))) %>%
  
      tab_style(
        style = list(
            cell_fill(color = 'gray27', alpha = 0.15),
            cell_text(size = 'large', weight = 'bold',align = 'left')

        ),
        locations = cells_row_groups()) 

tab_history %>% 
  
  tab_options(data_row.padding = px(4),table.width = pct(100),
            column_labels.font.size = pct(50),
            column_labels.vlines.width = 1, table.font.size = pct(80)) %>%
                tab_options(data_row.padding = px(6),
                column_labels.font.size = pct(100)) %>% 
  tab_style(style = cell_text(weight = 1200, align = 'left'),locations = cells_title(groups = 'title')) %>%
    tab_style(style = cell_text(color = 'darkgrey', transform = 'uppercase', align = 'center'),
              locations = cells_column_labels(everything())) 
```


```{r, results='asis'}
gt(Sharpe_data) %>% tab_options(data_row.padding = px(4),table.width = pct(100),
            column_labels.font.size = pct(50),
            column_labels.vlines.width = 1, table.font.size = pct(80)) %>%
                tab_options(data_row.padding = px(6),
                column_labels.font.size = pct(100)) %>% 
      tab_header(title = glue::glue("Table 2: Adjusted Sharpe Ratio: Relative to {BM}")) %>% 
  
   tab_footnote( footnote = 'Utilising the US 3-Month Libor Rate as a proxy for the risk-free rate',
                locations = cells_column_labels(columns = contains('Info'))) %>%
 
  tab_style(style = cell_text(weight = 1200, align = 'left'),locations = cells_title(groups = 'title')) %>%
    tab_style(style = cell_text(color = 'darkgrey', transform = 'uppercase', align = 'center'),
              locations = cells_column_labels(everything()))
```

## Stratified Sample Periods

Tables 3 and 4 provide a more detailed exploration of the statistics presented in Tables 1 and 2. Specifically, the analysis stratifies high and low volatility periods concerning exchange rate movements (between the South African Rand and the US Dollar), gold movements, and Brent crude oil movements. The focus is on understanding how each portfolio reacts relative to the S&P 500 index during these different volatility conditions.

The inclusion of exchange rate movement (US Dollar to Rand) is crucial when constructing a portfolio with both local (South African) and global (US) assets. Currency fluctuations can significantly impact portfolio value, as changes in exchange rates affect the value of global assets when converted back to the local currency. Foreign exchange exposure involves the risk that fluctuations in exchange rates will influence the value of a portfolio's assets, liabilities, or cash flows. For a portfolio with both local and global assets, shifts in the exchange rate between the Rand and the US Dollar can impact the value of US assets when converted back to Rand. 

In the context of gold and Brent crude oil literature, extensive research demonstrates the spillover effects of the global crude oil and gold markets on equity and bond markets[^1].

[^1]: For interested readers, relevant literature includes @dai2021bond, @balcilar2020oil, @morrison2019energy, @kang2014impact, @akhtaruzzaman2021gold, @cohen2010gold, @lucey2003international, @sadorsky1999oil, @chiang2013relationships, @shahzad2017dependence, @choudhry2015relationship, @morema2020impact, @gomes2014volatility. However, these references won't be expanded upon in this analysis, as they fall outside the focus of this study.




<!-- ### Market conditions -->
<!-- Divide your data based on different market conditions, such as bull markets, bear markets, or periods of economic expansion and contraction. -->
<!-- Explore how your portfolio reacts to varying market environments for both local and global assets. -->


```{r}

# # Load required libraries
# library(zoo)
# library(dplyr)
# # Winzorising:
# 
# Idxs <-
#   
# all_portfolios %>% gather(Portfolio, Return,-date) %>%
#     mutate(Year = format(date, "%Y")) %>%  group_by(Portfolio) %>% 
#   
#   mutate(Top = quantile(Return, 0.99), Bot = quantile(Return, 0.01)) %>% 
#   
#   mutate(Return = ifelse(Return > Top, Top, 
#                          
#                          ifelse(Return < Bot, Bot, Return))) %>% ungroup()
# 
# 
# # Calculate returns
# returns <-return_mat %>%
#   mutate(total_returns = `GlobalAgg Unhedged USD` + ALBI + J433 + `MSCI ACWI`) %>%
#   select(date, total_returns) 
# 
# # Calculate price trends
# price_trends <- diff(returns$total_returns)
# 
# # Calculate moving averages
# short_window <- 12
# long_window <- 24
# short_ma <- rollapplyr(returns$total_returns, short_window, mean)
# long_ma <- rollapplyr(returns$total_returns, long_window, mean)
# 
# # Calculate volatility
# volatility <- sd(returns$total_returns)
# 
#  # Classify market
#   market_conditions <- case_when(
#     price_trends > 0 & short_ma > long_ma ~ "Bull Market",
#     price_trends < 0 & short_ma < long_ma ~ "Bear Market",
#     TRUE ~ "Neutral"
#   )
# 
#   # Extract dates for Bull and Bear markets
#   bull_dates <- returns$date[price_trends > 0 & short_ma > long_ma]
#   bear_dates <- returns$date[price_trends < 0 & short_ma < long_ma]
#   
# 
#   
# Comparisons <- function(Idxs, Ys, Alias){
#    
#     Unconditional_SD <- 
#         
#         Idxs %>% 
#         
#         group_by(Portfolio) %>% 
#         
#         mutate(Full_SD = sd(Return) * sqrt(12)) %>% 
#         
#         filter(date %in% Ys) %>% 
#         
#         summarise(SD = sd(Return) * sqrt(12), across(.cols = starts_with("Full"), .fns = max)) %>% 
#         
#         arrange(desc(SD)) %>% 
#         
#         group_by(Portfolio) %>% 
#         
#         mutate(Ratio = SD / Full_SD)
#     
#     Unconditional_SD
#     
# }
# 
# Bull_market <- Comparisons(Idxs, Ys = bull_dates)
# Bear_market <- Comparisons(Idxs, Ys = bear_dates)

```

```{r}
Monthly_ZAR <- read_rds("/Users/gabriellaneilon/Library/Mobile Documents/com~apple~CloudDocs/Masters/Data_23/Monthly_zar.rds")
ZAR.USD <- Monthly_ZAR  %>% tbl_xts(., cols_to_xts = value, spread_by = Tickers) %>% xts_tbl()%>%  mutate(ZAR.USD.Return=X.ZAR.USD/lag(X.ZAR.USD)-1) %>% select(-X.ZAR.USD) %>% gather("Index", "Return",-date)


ZARSD <- ZAR.USD %>% 
    filter(date>=lubridate::ymd(20020228)) %>% #to match the index data
  mutate(Year = format(date, "%Y"))%>% #we have montly data so we need to look at yearly rather
    arrange(date) %>% 
    group_by(Year) %>% summarise(SD = sd(Return)*sqrt(12)) %>% 
    
    # Top Decile Quantile overall (highly volatile month for ZAR:
    mutate(TopQtile = quantile(SD, 0.8, na.rm = TRUE),
           
           BotQtile = quantile(SD, 0.2, na.rm = TRUE))



Hi_Vol <- ZARSD %>% filter(SD > TopQtile) %>% pull(Year)

Low_Vol <- ZARSD %>% filter(SD < BotQtile) %>% pull(Year)






SD_comp <- function(funds, BM, Period, Time) {
  
  portfolios_xts <- funds %>%group_by(Portfolio) %>% 
  
   mutate(Top = quantile(Return, 0.99), Bot = quantile(Return, 0.01)) %>% 
  
   mutate(Return = ifelse(Return > Top, Top, 
                          
                          ifelse(Return < Bot, Bot, Return))) %>% 
    mutate(Year = format(date, "%Y")) %>%
    filter(Year %in% Period) %>%
    tbl_xts(cols_to_xts = Return, spread_by = Portfolio, Colnames_Exact = TRUE)

  spxts <- sp500 %>%
    filter(date >= "2002-03-31") %>%
    mutate(Year = format(date, "%Y")) %>%
    filter(Year %in% Period) %>%
    tbl_xts(Colnames_Exact = TRUE)

  Moments_SD <- bind_rows(
    data.frame(Return.annualized(portfolios_xts, scale = 12, geometric = TRUE)) %>% round(., 3),
    data.frame(PerformanceAnalytics::Return.annualized.excess(portfolios_xts, spxts)) %>% round(., 3),
    data.frame(PerformanceAnalytics::AdjustedSharpeRatio(portfolios_xts)) %>% round(., 3),
    data.frame(PainIndex(portfolios_xts, scale = 12, geometric = TRUE)) %>% round(., 3),
    data.frame(AverageDrawdown(portfolios_xts, scale = 12)) %>% round(., 3),
    data.frame(fmxdat::Safe_TE(Ra = portfolios_xts, Rb = spxts, scale = 12)) %>% round(., 3),
    data.frame(PerformanceAnalytics::InformationRatio(Ra = portfolios_xts, Rb = spxts)) %>% round(., 3),
    data.frame(PerformanceAnalytics::CVaR(R = portfolios_xts, p = 0.05, method = "modified")) %>% round(., 3)
  ) %>% 
    tibble::rownames_to_column("Info") %>% 
    mutate(Time = glue::glue("{Time}"), Info = c( "Returns (Ann.)", "Returns Excess (Ann.)",  "Adj. Sharpe Ratio", "Pain Index", 
                                                       "Avg DD", "Tracking Error", "Information Ratio", "Modified CVaR"))%>% 
        relocate(Time, .before = Info) %>% as_tibble() 

  colnames(Moments_SD) <- gsub("\\.", " ", colnames(Moments_SD))
  
  Moments_SD
}

Fundselected <- c("SP 500", "Risk Parity", "MVP", "MVO", "EW")
High_comp <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Hi_Vol, Time="High Volatility Currency Movements")

Low_comp <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Low_Vol, Time="Low Volatility Currency Movements")
```


```{r}
Make_table <- function(Tab, BM, Table=1) {
  Make_perc<- c("Returns (Ann.)", "Returns Excess (Ann.)",  "Avg DD", "Tracking Error")

  Rows_to_Perc <- Tab %>%
    mutate(RN = row_number()) %>%
    filter(Info %in% Make_perc) %>%
    pull(RN)

  colnams<- colnames(Tab)
  Cols_length <- ncol(Tab)

  tab <- Tab %>%
    gt(groupname_col = 'Time', caption = "Index Statistics: Relative to {BM}") %>%
    tab_header(title = glue::glue("Table {Table}: Fund Moments Comparison")) %>%
    fmt_percent(
      columns = 2:Cols_length,
      rows = Rows_to_Perc,
      decimals = 1
    ) %>%
    sub_missing(
      columns = all_of(colnams),
      missing_text = '-'
    ) %>%
    tab_footnote(
      footnote = 'Utilising the US 3-Month Libor Rate as a proxy for the risk-free rate, except for Adjsuted Sharpe Ratio which uses a 0% risk-free rate',
      locations = cells_column_labels(columns = contains('Info'))
    ) %>%
    tab_style(
      style = list(
        cell_fill(color = 'gray27', alpha = 0.15),
        cell_text(size = 'large', weight = 'bold', align = 'left')
      ),
      locations = cells_row_groups()
    )

  tab %>%
    tab_options(
      data_row.padding = px(4),
      table.width = pct(100),
      column_labels.font.size = pct(50),
      column_labels.vlines.width = 1,
      table.font.size = pct(80)
    ) %>%
    tab_options(
      data_row.padding = px(6),
      column_labels.font.size = pct(100)
    ) %>%
    tab_style(
      style = cell_text(weight = 1200, align = 'left'),
      locations = cells_title(groups = 'title')
    ) %>%
    tab_style(
      style = cell_text(color = 'darkgrey', transform = 'uppercase', align = 'center'),
      locations = cells_column_labels(everything())
    )
}

# Example usage



```
```{r}

```



```{r}


# Load required libraries
library(zoo)
library(dplyr)


gold <- return_mat %>%select(date,`Gold Spot $/Oz (GOLDS COMDTY)`) %>% 
    filter(date>=lubridate::ymd(20020228)) %>% #to match the index data
  mutate(Year = format(date, "%Y"))%>% #we have montly data so we need to look at yearly rather
    arrange(date) %>% 
    group_by(Year) %>% summarise(SD = sd(`Gold Spot $/Oz (GOLDS COMDTY)`)*sqrt(12)) %>% 
    
    # Top Decile Quantile overall (highly volatile month for ZAR:
    mutate(TopQtile = quantile(SD, 0.8, na.rm = TRUE),
           
           BotQtile = quantile(SD, 0.2, na.rm = TRUE))



  # Extract dates 

Hi_gold <- gold %>% filter(SD > TopQtile) %>% pull(Year)

Low_gold  <- gold  %>% filter(SD < BotQtile) %>% pull(Year)

High_comp_gold <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Hi_gold, Time="High Volatility Gold Movements")

Low_comp_gold <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Low_gold, Time="Low Volatility Gold Movements")



```




```{r}
brent <- combined_data %>% select(date, BRENT) %>% 
    filter(date>=lubridate::ymd(20020228)) %>% #to match the index data
  mutate(Year = format(date, "%Y"))%>% #we have montly data so we need to look at yearly rather
    arrange(date) %>% 
    group_by(Year) %>% summarise(SD = sd(BRENT)*sqrt(12)) %>% 
    
    # Top Decile Quantile overall (highly volatile month for ZAR:
    mutate(TopQtile = quantile(SD, 0.8, na.rm = TRUE),
           
           BotQtile = quantile(SD, 0.2, na.rm = TRUE))



  # Extract dates 

Hi_brent <- brent %>% filter(SD > TopQtile) %>% pull(Year)

Low_brent  <- brent %>% filter(SD < BotQtile) %>% pull(Year)

High_comp_brent <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Hi_brent, Time="High Volatility Brent Movements")

Low_comp_brent <- SD_comp(comparison_data %>% filter(Portfolio %in% Fundselected), BM, Period = Low_brent, Time="Low Volatility Brent Movements")


```
Table 3 presents high volatility scenarios for the portfolios in comparison to the S&P 500 index.

In terms of risk-adjusted performance, the Risk Parity portfolio consistently exhibits a lower adjusted Sharpe ratio compared to the other portfolios. However, it still outperforms the S&P 500 index. Notably, the MVP portfolio stands out with the most promising risk-adjusted returns among the portfolios.

It is interesting to observe that all the portfolios surpass the benchmark index, aligning with the trends identified in Figures \ref{Figure4} through \ref{Figure8}. This consistency in outperformance suggests the effectiveness of the selected portfolio strategies across various market conditions and reinforces their potential for delivering superior risk-adjusted returns compared to the S&P 500.

```{r}
High_vol_movements <- bind_rows(High_comp, High_comp_gold,High_comp_brent)

Make_table(High_vol_movements, BM, Table=3)
```


Compared to the previous table, the performance of the portfolios (Table 4) are generally better under the low volatility scenarios than under the high volatility scenarios. 
```{r}
Low_vol_movements <- bind_rows(Low_comp, Low_comp_gold,Low_comp_brent)

Make_table(Low_vol_movements, BM, Table=4)

```




# Conclusion{-}

The analysis different portfolio startegies can be useful when investots evaluate risk-adjusted performance that align with their risk tolerance. For risk-averse investors prioritizing capital preservation, the MVP strategy may be favored despite its negative excess return, given its lower volatility and pain index. In contrast, risk-tolerant investors seeking higher returns may lean towards MVO or EW, which exhibit higher excess return statistics and upside potential.

```{r}
# 
# W_BPWeight_MinVol_new <- 
#       Portfolio_MinVol$EOP.Weight %>% xts_tbl()  
# W_BPWeight_MinVol_new%>% tbl_xts() %>% .[endpoints(.,'months')] %>% chart.StackedBar() #
```


<!-- The figure on the left-hand side shows the `cars` data. -->

<!-- Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do -->
<!-- eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut -->
<!-- enim ad minim veniam, quis nostrud exercitation ullamco laboris -->
<!-- nisi ut aliquip ex ea commodo consequat. -->
<!-- ::: -->
<!-- :::::: -->


<!-- $$ -->
<!-- This is a commented out section in the writing part. -->
<!-- Comments are created by highlighting text, amnd pressing CTL+C -->
<!-- \\begin{align} -->
<!-- \\beta = \\alpha^2 -->
<!-- \end{align} -->
<!-- $$ -->




\hfill

<!-- hfill can be used to create a space, like here between text and table. -->





<!-- Make title of bibliography here: -->
<!-- \newpage -->

\newpage

\newpage

# References {-}

<div id="refs"></div>



